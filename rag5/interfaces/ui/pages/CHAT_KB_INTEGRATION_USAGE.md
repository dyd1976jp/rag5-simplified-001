# 聊天页面知识库集成使用指南

## 概述

聊天页面现已集成知识库选择器功能，允许用户在聊天时选择特定的知识库进行查询，或使用默认的全部知识库。

## 功能特性

### 1. 知识库选择器

在聊天页面的侧边栏中，用户可以看到一个知识库选择器：

- **位置**: 侧边栏顶部，"🎯 知识库选择" 部分
- **选项**: 
  - "默认（全部知识库）" - 使用系统默认知识库
  - 各个已创建的知识库名称
- **显示信息**:
  - 当前选择的知识库名称
  - 知识库 ID（前 8 位）
  - 使用状态提示

### 2. 知识库隔离查询

当用户选择特定知识库后：

- 所有查询将仅在该知识库中搜索
- 使用该知识库的配置（embedding_model, retrieval_config）
- 搜索结果仅来自该知识库的文档

### 3. 会话状态管理

知识库选择会保存在会话状态中：

- 在同一会话中切换页面后返回，选择仍然保留
- 可以随时更改知识库选择
- 更改后的查询将使用新选择的知识库

## 使用方法

### 基本使用流程

1. **打开聊天页面**
   - 在主应用中选择 "💬 聊天" 页面

2. **选择知识库**
   - 在侧边栏找到 "🎯 知识库选择" 部分
   - 从下拉菜单中选择目标知识库
   - 或保持 "默认（全部知识库）" 使用默认设置

3. **开始对话**
   - 在输入框中输入问题
   - 系统将在选定的知识库中搜索相关信息
   - 查看 AI 基于该知识库的回答

4. **切换知识库**
   - 随时可以在侧边栏更改知识库选择
   - 新的查询将使用新选择的知识库

### 示例场景

#### 场景 1: 查询特定领域知识库

```
1. 选择知识库: "财务文档"
2. 提问: "公司去年的营收是多少？"
3. 系统仅在 "财务文档" 知识库中搜索
4. 返回基于财务文档的准确答案
```

#### 场景 2: 使用默认知识库

```
1. 选择: "默认（全部知识库）"
2. 提问: "李小勇和人合作入股了什么公司？"
3. 系统在默认知识库中搜索
4. 返回基于所有已索引文档的答案
```

#### 场景 3: 多轮对话中切换知识库

```
1. 选择知识库: "产品文档"
2. 提问: "产品 A 的主要功能是什么？"
3. 获得答案后，切换到 "技术文档"
4. 提问: "如何部署产品 A？"
5. 系统在新的知识库中搜索技术信息
```

## 技术实现

### API 集成

知识库选择器通过以下方式工作：

1. **获取知识库列表**
   ```python
   from rag5.interfaces.ui.pages.knowledge_base.api_client import KnowledgeBaseAPIClient
   
   api_client = KnowledgeBaseAPIClient()
   response = api_client.list_knowledge_bases(page=1, size=100)
   kbs = response.get("items", [])
   ```

2. **保存选择到会话状态**
   ```python
   from rag5.interfaces.ui.state import SessionState
   
   SessionState.set_kb_for_chat(kb_id)
   ```

3. **传递给代理**
   ```python
   from rag5.core.agent.agent import ask
   
   kb_id = SessionState.get_kb_for_chat()
   response = ask(prompt, history, kb_id=kb_id)
   ```

### 代理处理

代理在处理查询时：

1. 接收 `kb_id` 参数
2. 在系统提示中添加知识库指令
3. 调用 `search_knowledge_base` 工具时传入 `kb_id`
4. 工具使用知识库管理器进行隔离查询

### 向后兼容

- 如果未选择知识库（`kb_id=None`），系统使用默认行为
- 现有代码无需修改即可继续工作
- 新功能是可选的增强

## 错误处理

### 知识库列表加载失败

如果无法加载知识库列表：

- 显示警告消息: "⚠️ 无法加载知识库列表"
- 显示错误详情
- 自动回退到默认知识库
- 用户仍可正常使用聊天功能

### API 连接问题

如果 API 服务不可用：

- 选择器显示警告
- 提示用户将使用默认知识库
- 聊天功能继续工作（使用默认配置）

## 配置

### 环境变量

```bash
# API 基础 URL（默认: http://localhost:8000）
API_BASE_URL=http://localhost:8000

# API 超时时间（默认: 30 秒）
API_TIMEOUT=30
```

### 知识库管理器配置

知识库管理器使用以下配置：

```python
# 数据库路径
kb_database_path = "data/knowledge_bases.db"

# 文件存储路径
kb_file_storage_path = "docs"

# Qdrant URL
qdrant_url = "http://localhost:6333"
```

## 最佳实践

### 1. 知识库组织

- 为不同领域创建独立的知识库
- 使用清晰的命名约定
- 在知识库描述中说明内容范围

### 2. 查询优化

- 选择最相关的知识库进行查询
- 对于跨领域问题，使用默认知识库
- 根据查询结果调整知识库选择

### 3. 会话管理

- 在同一主题的多轮对话中保持知识库选择
- 切换主题时及时更改知识库
- 定期清空对话历史以避免上下文混淆

## 故障排除

### 问题: 知识库选择器不显示

**可能原因**:
- API 服务未启动
- 网络连接问题
- 权限问题

**解决方法**:
1. 确认 API 服务正在运行: `python scripts/run_api.py`
2. 检查 API URL 配置
3. 查看浏览器控制台错误信息

### 问题: 选择知识库后查询无结果

**可能原因**:
- 知识库为空（未上传文档）
- 查询与知识库内容不匹配
- 相似度阈值过高

**解决方法**:
1. 在知识库管理页面检查文件列表
2. 使用检索测试功能验证知识库内容
3. 调整知识库的相似度阈值设置

### 问题: 切换知识库后仍使用旧知识库

**可能原因**:
- 会话状态未正确更新
- 浏览器缓存问题

**解决方法**:
1. 刷新页面
2. 清除浏览器缓存
3. 重新选择知识库

## 相关文档

- [知识库管理 API 文档](../knowledge_base/API_CLIENT_USAGE.md)
- [知识库列表页面使用指南](../knowledge_base/LIST_PAGE_USAGE.md)
- [知识库详情页面使用指南](../knowledge_base/DETAIL_PAGE_USAGE.md)
- [检索测试功能使用指南](../knowledge_base/RETRIEVAL_TEST_USAGE.md)

## 更新日志

### v1.0.0 (2024-01-XX)

- ✨ 新增知识库选择器到聊天页面侧边栏
- ✨ 支持在特定知识库中进行隔离查询
- ✨ 添加当前知识库状态显示
- ✨ 实现会话状态管理
- ✨ 支持向后兼容的默认知识库模式
- 🐛 修复知识库列表加载失败时的错误处理
- 📝 添加完整的使用文档和示例
